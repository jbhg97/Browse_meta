---
title: "Mammal browsing control meta-analysis results"
author: "Jamie"
format: html
editor: visual
---

# Non-lethal mammal control Meta analysis - Results

```{r}
library(pacman)
p_load(tidyverse, readxl, writexl, kableExtra, orchaRd)
```

## Literature synthesis

(Fill gaps with information from Prelim_process quarto doc or from tables produced in this doc)

```{r}
#code to do the average effects per paper
#Run code chunks from prelim_process to add Paper IDs to dataframe - take df1

df_avg <- df1 %>% group_by(Paper_ID) %>% 
  summarise(count = n())

df_avg <- df_avg %>% 
  summarise(N = nrow(df_avg),
            mean = mean(df_avg$count),
            sd = sd(df_avg$count),
            min = min(df_avg$count),
            max = max(df_avg$count))
```

Data were extracted from XXX papers, resulting in XXXX pairwise effect sizes (XXX SMD effects and XXX Log odds effects). Papers contributed an average of XXX +- XXX (mean +- SD) effect sizes to the data set (range: X-X). Experiments were distributed globally across XX countries, see Fig XXX (map of distribution of studies). One study conducted experiments in two countries (Barrere et al., 2021): France and Sweden, hence why N = number of papers + 1.

```{r}
#packages
p_load(sf, rnaturalearth, rnaturalearthdata)

#edit strings for map making packages
df_map <- df1 %>% 
  mutate(Country = case_when(Country == "USA" ~ "United States of America",
                   Country == "UK" ~"United Kingdom",
                   TRUE ~ Country))

#get unique combinations of study and country - should be No. of studies + 1 because of Barrere et al
df_map1 <- df_map %>% 
  group_by(ref, Country) %>% 
  distinct(ref, Country) %>% 
  ungroup() %>% select(Country)

df_map_inset <- df_map1 %>% 
  count(Country, name = "N") %>% 
  arrange(desc(N))

#map
world <- ne_countries(scale = "medium", returnclass = "sf")
world <- subset(world, continent != "Antarctica") #Antarctica is unnecessary for this map - no forests

world <- merge(world, df_map_inset, by.x = "name", by.y = "Country", all.x = TRUE)
world$N[is.na(world$N)] <- 0
world$is_zero <- ifelse(world$N == 0, "Zero", "Non-zero")

map_plot <- ggplot() +
  geom_sf(data = world[world$is_zero == "Zero", ], fill = "lightgrey", color = "black") +
  geom_sf(data = world[world$is_zero == "Non-zero", ], aes(fill = N)) +
  scale_fill_gradient(low = "lightblue", high = "darkgreen", name = "N") +
  labs(caption = str_wrap("Fig XX. A map showing the distribution of experimental locations globally. Grey denotes N = 0. Inset table shows the number of papers that conducted experiments in given countries; note that N = No. of papers + 1 as Barrere et al. (2021) conducted experiments in both France and Sweden.", width = 110)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "mm"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.caption = element_text(hjust = 0.5))

print(map_plot)

#still want to add an inset table - it will increase the clarity of the figure as some of the small numbers are not easy to discern based solely on colour or make USA single colour then the others will be spread better?
```

Next tasks - write results for breakdown of the effects into broad categories. Produce tables for N \>25? and then a full table for supp info. Table will include avg effect size with SD/SE.

```{r}
#Table for supp info 

```

```{r}
#Table for main text


```

## Complete case analysis

### Plant scale

Read in

```{r}
df_comp_plant <- read_xlsx("/homevol/jbhg/Browse_meta/Analysis/Comp_comb_plant.xlsx")

#add an observation level factor
df_comp_plant <- df_comp_plant %>% mutate(OLRE = row_number())
```

Build Variance Covariance matrix using shared data column

```{r}
CVC_mat_plant <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_plant, rho = 0.5)
```
Multilevel Meta-analytic model

```{r}
plant_MMA_mod1 <- rma.mv(Effect_size ~ 1, V = CVC_mat_plant, random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)

summary(plant_MMA_mod1)

orchaRd::i2_ml(plant_MMA_mod1)
```

Meta-regression models

```{r}
plant_MR_mod1 <- rma.mv(Effect_size ~ Method + Animal, V = CVC_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)

summary(plant_MR_mod1)
```

Non-independence sensitivity

```{r}
plant_MR_mod1_rob <- robust(plant_MR_mod1, cluster = df_comp_plant$Paper_ID)
```

### Coupe scale

### Landscape scale

## Imputed case analysis

### Plant scale

### Coupe scale

### Landscape scale


