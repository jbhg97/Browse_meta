---
title: "Mammal browsing control meta-analysis modelling"
author: "James Grimsdale and Dan Noble"
format: html
editor: visual
---

# Non-lethal mammal control Meta analysis - Models

```{r}
library(pacman)
devtools::install_github("daniel1noble/orchaRd", ref = "main", force = TRUE)
p_load(tidyverse, readxl, writexl, kableExtra, orchaRd, clubSandwich, metafor, mice, orchaRd, here, parallel, doParallel)
```

## Complete case analysis

### Divide data

```{r}
df_comp_all <- read_xlsx(here("Data processing", "Meta_full_data.xlsx"), sheet = "Complete case effects") # reading in from here rather than file in Analysis folder as for an unnknown reason read in from All_compcase_es.xlsx converts Count columns to Boolean.

df_comp_plant <- df_comp_all %>% filter(Scale == "Plant")
  
df_comp_coupe <- df_comp_all %>% filter(Scale == "Coupe")
  
df_comp_lscape <- df_comp_all %>% filter(Scale == "Landscape")
```

### Plant scale

Observation level random effect (OLRE)

```{r}
df_comp_plant <- df_comp_plant %>% mutate(OLRE = as.factor(row_number()))
```

#### Variance Covariance matrix

Use the shared data column to build a VCV matrix to be used in all models.

```{r}
VCV_mat_plant <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_plant, rho = 0.5, nearpd = TRUE)
```

#### Multilevel Meta-analytic model

Includes robust sensitivity analysis

```{r}
plant_MMA_mod1 <- rma.mv(Effect_size ~ 1, V = VCV_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)

summary(plant_MMA_mod1)

orchaRd::i2_ml(plant_MMA_mod1)

plant_MMA_rob <- robust(plant_MMA_mod1, cluster = df_comp_plant$Paper_ID)
```

Visualise the overall effect

```{r}
orchard_plot(plant_MMA_mod1, group = "Paper_ID", xlab = "SMD")
```

#### Multilevel Meta-regression models

```{r}
plant_MR_mod1 <- rma.mv(Effect_size ~ Method + Plot_size, V = VCV_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)
summary(plant_MR_mod1)

plant_MR_mod2 <- rma.mv(Effect_size ~ -1 + Method + Plot_size, V = VCV_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant) #suppressed intercept
summary(plant_MR_mod2)

plant_MR_mod3 <- rma.mv(Effect_size ~ Animal + Plot_size, V = VCV_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)
summary(plant_MR_mod3)

plant_MR_mod4 <- rma.mv(Effect_size ~ -1 + Animal + Plot_size, V = VCV_mat_plant, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant)
summary(plant_MR_mod4)

df_comp_plant1 <- df_comp_plant %>% filter(!Method == "Exclusion fence") # not enough effects to model slope
VCV_mat_plant1 <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_plant1, rho = 0.5, nearpd = TRUE)

plant_MR_mod5<- rma.mv(Effect_size ~ Months + Plot_size, V = VCV_mat_plant1, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant1) #method removed from model as all observations are repellents
summary(plant_MR_mod5)
```

#### Orchard plots

```{r}
orchard_plot(plant_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "SMD")
mod_results(plant_MR_mod1, mod = "Method", group = "Paper_ID")

orchard_plot(plant_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "SMD")
mod_results(plant_MR_mod3, mod = "Animal", group = "Paper_ID")

plant_MR5_bub <- mod_results(plant_MR_mod5, mod = "Months", group = "Paper_ID")
bubble_plot(plant_MR5_bub, mod = "Months", group = "Paper_ID", xlab = "Months")
```

#### Non-independence sensitivity

```{r}
plant_MR_mod1_rob <- robust(plant_MR_mod1, cluster = df_comp_plant$Paper_ID)
summary(plant_MR_mod1_rob)

plant_MR_mod2_rob <- robust(plant_MR_mod2, cluster = df_comp_plant$Paper_ID)
summary(plant_MR_mod2_rob)

plant_MR_mod3_rob <- robust(plant_MR_mod3, cluster = df_comp_plant$Paper_ID)
summary(plant_MR_mod3_rob)

plant_MR_mod4_rob <- robust(plant_MR_mod4, cluster = df_comp_plant$Paper_ID)
summary(plant_MR_mod4_rob)

plant_MR_mod5_rob <- robust(plant_MR_mod5, cluster = df_comp_plant1$Paper_ID)
summary(plant_MR_mod5_rob)
```

#### Sensitivity plots

Is there a discrepancy between data that were transformed? Or data that were converted from log odds.

```{r}
ggplot(df_comp_plant, aes(Effect_size, Sampling_variance, colour = Trans)) + geom_point() + theme_bw()

ggplot(df_comp_plant, aes(Effect_size, Sampling_variance, colour = Effect_type)) + geom_point() + theme_bw()
```

#### Publication bias

##### Funnel plots

Will need to use the effective sample size rather than the precision due to the correlation between sampling variance (used to derive precision) and SMD effect size.

```{r}
df_comp_plant_pb <- df_comp_plant %>% mutate(Eff_SS = (4*(Con_N*Trt_N)) / (Con_N + Trt_N))
```

```{r}
funnel(df_comp_plant_pb$Effect_size, df_comp_plant_pb$Sampling_variance, ni = df_comp_plant_pb$Eff_SS, yaxis="ni",
       ylab = "Effective sample size",
       xlab = "Effect size (SMD)") 
```

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size
df_comp_plant_pb2 <- df_comp_plant2 %>% mutate(Year = Year - mean(Year),
                                            root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )

df_comp_plant_pb3 <- df_comp_plant1 %>% mutate(Year = Year - mean(Year),
                                            root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )
```

```{r}
plant_MMA_pb1 <- rma.mv(Effect_size, V = VCV_mat_plant, mods = ~ 1 + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb2)
summary(plant_MMA_pb1)

plant_MMA_pb1_rob <- robust(plant_MMA_pb1, cluster = df_comp_plant_pb2$Paper_ID)
```

```{r}
plant_MR_pb1 <- rma.mv(Effect_size, V = VCV_mat_plant, mods = ~ Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb2)
summary(plant_MR_pb1)

plant_MR_pb2 <- rma.mv(Effect_size, V = VCV_mat_plant, mods = ~ -1 + Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb2)
summary(plant_MR_pb2)

plant_MR_pb3 <- rma.mv(Effect_size, V = VCV_mat_plant, mods = ~ Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb2)
summary(plant_MR_pb3)

plant_MR_pb4 <- rma.mv(Effect_size, V = VCV_mat_plant, mods = ~ -1 + Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb2)
summary(plant_MR_pb4)

plant_MR_pb5 <- rma.mv(Effect_size, V = VCV_mat_plant1, mods = ~ Months + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_plant_pb4)
summary(plant_MR_pb5)
```

Robust sensitivity

```{r}
plant_MR_pb1_rob <- robust(plant_MR_pb1, cluster = df_comp_plant_pb2$Paper_ID)

plant_MR_pb2_rob <- robust(plant_MR_pb2, cluster = df_comp_plant_pb2$Paper_ID)

plant_MR_pb3_rob <- robust(plant_MR_pb3, cluster = df_comp_plant_pb2$Paper_ID)

plant_MR_pb4_rob <- robust(plant_MR_pb4, cluster = df_comp_plant_pb2$Paper_ID)

plant_MR_pb5_rob <- robust(plant_MR_pb5, cluster = df_comp_plant_pb3$Paper_ID)
```

#### Save objects

```{r}
saveRDS(plant_MMA_mod1, here("Results", "Models", "Plant", "Plant_MMA.rds"))
saveRDS(plant_MMA_pb1, here("Results", "Models", "Plant", "Plant_MMA_pb.rds"))
saveRDS(plant_MMA_rob, here("Results", "Models", "Plant", "Plant_MMA_rob.rds"))
saveRDS(plant_MMA_pb1_rob, here("Results", "Models", "Plant", "Plant_MMA_pb_rob.rds"))
saveRDS(plant_MR_mod1, here("Results", "Models", "Plant", "Plant_MR1.rds"))
saveRDS(plant_MR_mod2, here("Results", "Models", "Plant", "Plant_MR2.rds"))
saveRDS(plant_MR_mod3, here("Results", "Models", "Plant", "Plant_MR3.rds"))
saveRDS(plant_MR_mod4, here("Results", "Models", "Plant", "Plant_MR4.rds"))
saveRDS(plant_MR_mod5, here("Results", "Models", "Plant", "Plant_MR5.rds"))
saveRDS(plant_MR_mod1_rob, here("Results", "Models", "Plant", "Plant_MR1_rob.rds"))
saveRDS(plant_MR_mod2_rob, here("Results", "Models", "Plant", "Plant_MR2_rob.rds"))
saveRDS(plant_MR_mod3_rob, here("Results", "Models", "Plant", "Plant_MR3_rob.rds"))
saveRDS(plant_MR_mod4_rob, here("Results", "Models", "Plant", "Plant_MR4_rob.rds"))
saveRDS(plant_MR_mod5_rob, here("Results", "Models", "Plant", "Plant_MR5_rob.rds"))
saveRDS(plant_MR_pb1, here("Results", "Models", "Plant", "Plant_MR1_pb.rds"))
saveRDS(plant_MR_pb2, here("Results", "Models", "Plant", "Plant_MR2_pb.rds"))
saveRDS(plant_MR_pb3, here("Results", "Models", "Plant", "Plant_MR3_pb.rds"))
saveRDS(plant_MR_pb4, here("Results", "Models", "Plant", "Plant_MR4_pb.rds"))
saveRDS(plant_MR_pb5, here("Results", "Models", "Plant", "Plant_MR5_pb.rds"))
saveRDS(plant_MR_pb1_rob, here("Results", "Models", "Plant", "Plant_MR1_pb_rob.rds"))
saveRDS(plant_MR_pb2_rob, here("Results", "Models", "Plant", "Plant_MR2_pb_rob.rds"))
saveRDS(plant_MR_pb3_rob, here("Results", "Models", "Plant", "Plant_MR3_pb_rob.rds"))
saveRDS(plant_MR_pb4_rob, here("Results", "Models", "Plant", "Plant_MR4_pb_rob.rds"))
saveRDS(plant_MR_pb5_rob, here("Results", "Models", "Plant", "Plant_MR5_pb_rob.rds"))
```

### Coupe scale

Observation level random effect

```{r}
df_comp_coupe <- df_comp_coupe %>% mutate(OLRE = as.factor(row_number()))
```

#### Variance Covariance matrix

```{r}
VCV_mat_coupe <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_coupe, rho = 0.5, nearpd = TRUE)
```

#### Multilevel Meta-analytic model

```{r}
coupe_MMA_mod1 <- rma.mv(Effect_size ~ 1, V = VCV_mat_coupe, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe)

summary(coupe_MMA_mod1)

orchaRd::i2_ml(coupe_MMA_mod1)

coupe_MMA_rob <- robust(coupe_MMA_mod1, cluster = df_comp_coupe$Paper_ID)
```

Visualise the overall effect

```{r}
orchard_plot(coupe_MMA_mod1, group = "Paper_ID", xlab = "SMD")
```

#### Multilevel Meta-regression models

```{r}
#subset out guardian animal - too few effects (3 - same study) for it to go into models
df_comp_coupe1 <- df_comp_coupe %>% filter(!(Method == "Guardian animal"))
VCV_mat_coupe1 <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_coupe1, rho = 0.5, nearpd = TRUE)

coupe_MR_mod1 <- rma.mv(Effect_size ~ Method + Plot_size, V = VCV_mat_coupe1, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe1)
summary(coupe_MR_mod1)

coupe_MR_mod2 <- rma.mv(Effect_size ~ -1 + Method + Plot_size, V = VCV_mat_coupe1, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe1) #suppressed intercept
summary(coupe_MR_mod2)

coupe_MR_mod3 <- rma.mv(Effect_size ~ Animal + Plot_size, V = VCV_mat_coupe, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe)
summary(coupe_MR_mod3)

coupe_MR_mod4 <- rma.mv(Effect_size ~ -1 + Animal + Plot_size, V = VCV_mat_coupe, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe)
summary(coupe_MR_mod4)

coupe_MR_mod5<- rma.mv(Effect_size ~ Method * Months + Plot_size, V = VCV_mat_coupe1, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe1)
summary(coupe_MR_mod5)
```

#### Orchard plots

```{r}
orchard_plot(coupe_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "SMD", angle = 0, legend.pos = "top.left")
mod_results(coupe_MR_mod1, mod = "Method", group = "Paper_ID")

orchard_plot(coupe_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "SMD", angle = 0)
mod_results(coupe_MR_mod3, mod = "Animal", group = "Paper_ID")

coupe_MR5_bub <- mod_results(coupe_MR_mod5, mod = "Months", group = "Paper_ID", by = "Method")
bubble_plot(coupe_MR5_bub, mod = "Months", group = "Paper_ID", xlab = "Months", legend.pos = "bottom.right") 
```

#### Non-independence sensitivity

```{r}
coupe_MR_mod1_rob <- robust(coupe_MR_mod1, cluster = df_comp_coupe1$Paper_ID)
summary(coupe_MR_mod1_rob)

coupe_MR_mod2_rob <- robust(coupe_MR_mod2, cluster = df_comp_coupe1$Paper_ID)
summary(coupe_MR_mod1_rob)

coupe_MR_mod3_rob <- robust(coupe_MR_mod3, cluster = df_comp_coupe$Paper_ID)
summary(coupe_MR_mod3_rob)

coupe_MR_mod4_rob <- robust(coupe_MR_mod4, cluster = df_comp_coupe$Paper_ID)
summary(coupe_MR_mod1_rob)

coupe_MR_mod5_rob <- robust(coupe_MR_mod5, cluster = df_comp_coupe1$Paper_ID)
summary(coupe_MR_mod5_rob)
```

#### Sensitivity plots

Is there a discrepancy between data that were transformed? Or data that were converted from log odds.

```{r}
ggplot(df_comp_coupe, aes(Effect_size, Sampling_variance, colour = Trans)) + geom_point() + theme_bw()

ggplot(df_comp_coupe, aes(Effect_size, Sampling_variance, colour = Effect_type)) + geom_point() + theme_bw()
```

#### Publication bias

##### Funnel plots

Will need to use the effective sample size rather than the precision due to the correlation between sampling variance (used to derive precision) and SMD effect size.

```{r}
df_comp_coupe_pb <- df_comp_coupe %>% mutate(Eff_SS = (4*(Con_N*Trt_N)) / (Con_N + Trt_N))
```

```{r}
funnel(df_comp_coupe_pb$Effect_size, df_comp_coupe_pb$Sampling_variance, ni = df_comp_coupe_pb$Eff_SS, yaxis="ni",
       ylab = "Effective sample size",
       xlab = "Effect size (SMD)") 
```

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size
df_comp_coupe_pb2 <- df_comp_coupe %>% mutate(Year = Year - mean(Year),
                                            root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )

#subset version for some models
df_comp_coupe_pb3 <- df_comp_coupe1 %>% mutate(Year = Year - mean(Year),
                                            root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )
```

```{r}
coupe_MMA_pb1 <- rma.mv(Effect_size, V = VCV_mat_coupe, mods = ~ 1 + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb2)
summary(coupe_MMA_pb1)

coupe_MMA_pb_rob <- robust(coupe_MMA_pb1, cluster = df_comp_coupe_pb2$Paper_ID)
```

```{r}
coupe_MR_pb1 <- rma.mv(Effect_size, V = VCV_mat_coupe1, mods = ~ Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb3)
summary(coupe_MR_pb1)

coupe_MR_pb2 <- rma.mv(Effect_size, V = VCV_mat_coupe1, mods = ~ -1 + Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb3)
summary(coupe_MR_pb2)

coupe_MR_pb3 <- rma.mv(Effect_size, V = VCV_mat_coupe, mods = ~ Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb2)
summary(coupe_MR_pb3)

coupe_MR_pb4 <- rma.mv(Effect_size, V = VCV_mat_coupe, mods = ~ -1 + Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb2)
summary(coupe_MR_pb4)

coupe_MR_pb5 <- rma.mv(Effect_size, V = VCV_mat_coupe1, mods = ~ Method * Months + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_coupe_pb3)
summary(coupe_MR_pb5)
```

Robust sensitivity

```{r}
coupe_MR_pb1_rob <- robust(coupe_MR_pb1, cluster = df_comp_coupe_pb3$Paper_ID)

coupe_MR_pb2_rob <- robust(coupe_MR_pb2, cluster = df_comp_coupe_pb3$Paper_ID)

coupe_MR_pb3_rob <- robust(coupe_MR_pb3, cluster = df_comp_coupe_pb2$Paper_ID)

coupe_MR_pb4_rob <- robust(coupe_MR_pb4, cluster = df_comp_coupe_pb2$Paper_ID)

coupe_MR_pb5_rob <- robust(coupe_MR_pb5, cluster = df_comp_coupe_pb3$Paper_ID)
```

#### Save objects

```{r}
saveRDS(coupe_MMA_mod1, here("Results", "Models", "Coupe", "coupe_MMA.rds"))
saveRDS(coupe_MMA_pb1, here("Results", "Models", "Coupe", "coupe_MMA_pb.rds"))
saveRDS(coupe_MMA_rob, here("Results", "Models", "Coupe", "coupe_MMA_rob.rds"))
saveRDS(coupe_MMA_pb_rob, here("Results", "Models", "Coupe", "coupe_MMA_pb_rob.rds"))
saveRDS(coupe_MR_mod1, here("Results", "Models", "Coupe", "coupe_MR1.rds"))
saveRDS(coupe_MR_mod2, here("Results", "Models", "Coupe", "coupe_MR2.rds"))
saveRDS(coupe_MR_mod3, here("Results", "Models", "Coupe", "coupe_MR3.rds"))
saveRDS(coupe_MR_mod4, here("Results", "Models", "Coupe", "coupe_MR4.rds"))
saveRDS(coupe_MR_mod5, here("Results", "Models", "Coupe", "coupe_MR5.rds"))
saveRDS(coupe_MR_mod1_rob, here("Results", "Models", "Coupe", "coupe_MR1_rob.rds"))
saveRDS(coupe_MR_mod2_rob, here("Results", "Models", "Coupe", "coupe_MR2_rob.rds"))
saveRDS(coupe_MR_mod3_rob, here("Results", "Models", "Coupe", "coupe_MR3_rob.rds"))
saveRDS(coupe_MR_mod4_rob, here("Results", "Models", "Coupe", "coupe_MR4_rob.rds"))
saveRDS(coupe_MR_mod5_rob, here("Results", "Models", "Coupe", "coupe_MR5_rob.rds"))
saveRDS(coupe_MR_pb1, here("Results", "Models", "Coupe", "coupe_MR1_pb.rds"))
saveRDS(coupe_MR_pb2, here("Results", "Models", "Coupe", "coupe_MR2_pb.rds"))
saveRDS(coupe_MR_pb3, here("Results", "Models", "Coupe", "coupe_MR3_pb.rds"))
saveRDS(coupe_MR_pb4, here("Results", "Models", "Coupe", "coupe_MR4_pb.rds"))
saveRDS(coupe_MR_pb5, here("Results", "Models", "Coupe", "coupe_MR5_pb.rds"))
saveRDS(coupe_MR_pb1_rob, here("Results", "Models", "Coupe", "coupe_MR1_pb_rob.rds"))
saveRDS(coupe_MR_pb2_rob, here("Results", "Models", "Coupe", "coupe_MR2_pb_rob.rds"))
saveRDS(coupe_MR_pb3_rob, here("Results", "Models", "Coupe", "coupe_MR3_pb_rob.rds"))
saveRDS(coupe_MR_pb4_rob, here("Results", "Models", "Coupe", "coupe_MR4_pb_rob.rds"))
saveRDS(coupe_MR_pb5_rob, here("Results", "Models", "Coupe", "coupe_MR5_pb_rob.rds"))
```

### Landscape scale

Observation level random effect

```{r}
df_comp_lscape <- df_comp_lscape %>% mutate(OLRE = as.factor(row_number()))
```

#### Variance Covariance matrix

```{r}
VCV_mat_lscape <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_lscape, rho = 0.5, nearpd = TRUE)
```

#### Multilevel Meta-analytic model

```{r}
lscape_MMA_mod1 <- rma.mv(Effect_size ~ 1, V = VCV_mat_lscape, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape)

summary(lscape_MMA_mod1)

orchaRd::i2_ml(lscape_MMA_mod1)

lscape_MMA_rob <- robust(lscape_MMA_mod1, cluster = df_comp_lscape$Paper_ID)
```

Visualise the overall effect

```{r}
orchard_plot(lscape_MMA_mod1, group = "Paper_ID", xlab = "SMD")
```

#### Multilevel Meta-regression models

```{r}
lscape_MR_mod1 <- rma.mv(Effect_size ~ Method + Plot_size, V = VCV_mat_lscape, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape)
summary(lscape_MR_mod1)

lscape_MR_mod2 <- rma.mv(Effect_size ~ -1 + Method + Plot_size, V = VCV_mat_lscape, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape) #suppressed intercept
summary(lscape_MR_mod2)

lscape_MR_mod3 <- rma.mv(Effect_size ~ Animal + Plot_size, V = VCV_mat_lscape, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape)
summary(lscape_MR_mod3)

lscape_MR_mod4 <- rma.mv(Effect_size ~ -1 + Animal + Plot_size, V = VCV_mat_lscape, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape)
summary(lscape_MR_mod4)

# other fencing has no variation when months NAs are removed. Stock manipulation and neighbour effects have too few effects to reliably draw a slope (k<15). Need to make a new VCV matrix with the reduced sample size.

df_comp_lscape1 <- df_comp_lscape %>% filter(!(Method == "Other fencing" | Method == "Neighbour effects" | Method == "Stock manipulation"))

VCV_mat_lscape1 <- vcalc(vi = Sampling_variance, cluster = Shared_data, data = df_comp_lscape1, rho = 0.5, nearpd = TRUE)

lscape_MR_mod5<- rma.mv(Effect_size ~ Method * Months + Plot_size, V = VCV_mat_lscape1, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape1)
summary(lscape_MR_mod5)
```

#### Orchard plots

```{r}
orchard_plot(lscape_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "SMD", angle = 0)
mod_results(lscape_MR_mod1, mod = "Method", group = "Paper_ID")

orchard_plot(lscape_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "SMD", angle = 0)
mod_results(lscape_MR_mod3, mod = "Animal", group = "Paper_ID")

lscape_MR5_bub <- mod_results(lscape_MR_mod5, mod = "Months", group = "Paper_ID", by = "Method")
bubble_plot(lscape_MR5_bub, mod = "Months", group = "Paper_ID", xlab = "Months", legend.pos = "bottom.right")
```

#### Non-independence sensitivity

```{r}
lscape_MR_mod1_rob <- robust(lscape_MR_mod1, cluster = df_comp_lscape$Paper_ID)
summary(lscape_MR_mod1_rob)

lscape_MR_mod2_rob <- robust(lscape_MR_mod2, cluster = df_comp_lscape$Paper_ID)
summary(lscape_MR_mod2_rob)

lscape_MR_mod3_rob <- robust(lscape_MR_mod3, cluster = df_comp_lscape$Paper_ID)
summary(lscape_MR_mod3_rob)

lscape_MR_mod4_rob <- robust(lscape_MR_mod4, cluster = df_comp_lscape$Paper_ID)
summary(lscape_MR_mod4_rob)

lscape_MR_mod5_rob <- robust(lscape_MR_mod5, cluster = df_comp_lscape1$Paper_ID)
summary(lscape_MR_mod5_rob)
```

#### Sensitivity plots

Is there a discrepancy between data that were transformed? Or data that were converted from log odds?

```{r}
ggplot(df_comp_lscape, aes(Effect_size, Sampling_variance, colour = Trans)) + geom_point() + theme_bw() 

ggplot(df_comp_lscape, aes(Effect_size, Sampling_variance, colour = Effect_type)) + geom_point() + theme_bw()
```

#### Publication bias

##### Funnel plots

Will need to use the effective sample size rather than the precision due to the correlation between sampling variance (used to derive precision) and SMD effect size.

```{r}
df_comp_lscape_pb <- df_comp_lscape %>% mutate(Eff_SS = (4*(Con_N*Trt_N)) / (Con_N + Trt_N))
```

```{r}
funnel(df_comp_lscape_pb$Effect_size, df_comp_lscape_pb$Sampling_variance, ni = df_comp_lscape_pb$Eff_SS, yaxis="ni",
       ylab = "Effective sample size",
       xlab = "Effect size (SMD)") 
```

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size
df_comp_lscape_pb2 <- df_comp_lscape %>% mutate(Year = Year - mean(Year), 
                                                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )

#subset version for MR mod 5
df_comp_lscape_pb3 <- df_comp_lscape1 %>% mutate(Year = Year - mean(Year), 
                                                 root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) )
```

```{r}
lscape_MMA_pb <- rma.mv(Effect_size, V = VCV_mat_lscape, mods = ~ 1 + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb2)
summary(lscape_MMA_pb)

lscape_MMA_pb_rob <- robust(lscape_MMA_pb, cluster = df_comp_lscape_pb2$Paper_ID)
```

```{r}
lscape_MR_pb1 <- rma.mv(Effect_size, V = VCV_mat_lscape, mods = ~ Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb2)
summary(lscape_MR_pb1)

lscape_MR_pb2 <- rma.mv(Effect_size, V = VCV_mat_lscape, mods = ~ -1 + Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb2)
summary(lscape_MR_pb2)

lscape_MR_pb3 <- rma.mv(Effect_size, V = VCV_mat_lscape, mods = ~ Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb2)
summary(lscape_MR_pb3)

lscape_MR_pb4 <- rma.mv(Effect_size, V = VCV_mat_lscape, mods = ~ -1 + Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb2)
summary(lscape_MR_pb4)

lscape_MR_pb5 <- rma.mv(Effect_size, V = VCV_mat_lscape1, mods = ~ Method * Months + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_comp_lscape_pb3)
summary(lscape_MR_pb5)
```

```{r}
lscape_MR_pb1_rob <- robust(lscape_MR_pb1, cluster = df_comp_lscape_pb2$Paper_ID)

lscape_MR_pb2_rob <- robust(lscape_MR_pb2, cluster = df_comp_lscape_pb2$Paper_ID)

lscape_MR_pb3_rob <- robust(lscape_MR_pb3, cluster = df_comp_lscape_pb2$Paper_ID)

lscape_MR_pb4_rob <- robust(lscape_MR_pb4, cluster = df_comp_lscape_pb2$Paper_ID)

lscape_MR_pb5_rob <- robust(lscape_MR_pb5, cluster = df_comp_lscape_pb3$Paper_ID)
```

#### Save objects

```{r}
saveRDS(lscape_MMA_mod1, here("Results", "Models", "Landscape", "lscape_MMA.rds"))
saveRDS(lscape_MMA_pb, here("Results", "Models", "Landscape", "lscape_MMA_pb.rds"))
saveRDS(lscape_MMA_rob, here("Results", "Models", "Landscape", "lscape_MMA_rob.rds"))
saveRDS(lscape_MMA_pb_rob, here("Results", "Models", "Landscape", "lscape_MMA_pb_rob.rds"))
saveRDS(lscape_MR_mod1, here("Results", "Models", "Landscape", "lscape_MR1.rds"))
saveRDS(lscape_MR_mod2, here("Results", "Models", "Landscape", "lscape_MR2.rds"))
saveRDS(lscape_MR_mod3, here("Results", "Models", "Landscape", "lscape_MR3.rds"))
saveRDS(lscape_MR_mod4, here("Results", "Models", "Landscape", "lscape_MR4.rds"))
saveRDS(lscape_MR_mod5, here("Results", "Models", "Landscape", "lscape_MR5.rds"))
saveRDS(lscape_MR_mod1_rob, here("Results", "Models", "Landscape", "lscape_MR1_rob.rds"))
saveRDS(lscape_MR_mod2_rob, here("Results", "Models", "Landscape", "lscape_MR2_rob.rds"))
saveRDS(lscape_MR_mod3_rob, here("Results", "Models", "Landscape", "lscape_MR3_rob.rds"))
saveRDS(lscape_MR_mod4_rob, here("Results", "Models", "Landscape", "lscape_MR4_rob.rds"))
saveRDS(lscape_MR_mod5_rob, here("Results", "Models", "Landscape", "lscape_MR5_rob.rds"))
saveRDS(lscape_MR_pb1, here("Results", "Models", "Landscape", "lscape_MR1_pb.rds"))
saveRDS(lscape_MR_pb2, here("Results", "Models", "Landscape", "lscape_MR2_pb.rds"))
saveRDS(lscape_MR_pb3, here("Results", "Models", "Landscape", "lscape_MR3_pb.rds"))
saveRDS(lscape_MR_pb4, here("Results", "Models", "Landscape", "lscape_MR4_pb.rds"))
saveRDS(lscape_MR_pb5, here("Results", "Models", "Landscape", "lscape_MR5_pb.rds"))
saveRDS(lscape_MR_pb1_rob, here("Results", "Models", "Landscape", "lscape_MR1_pb_rob.rds"))
saveRDS(lscape_MR_pb2_rob, here("Results", "Models", "Landscape", "lscape_MR2_pb_rob.rds"))
saveRDS(lscape_MR_pb3_rob, here("Results", "Models", "Landscape", "lscape_MR3_pb_rob.rds"))
saveRDS(lscape_MR_pb4_rob, here("Results", "Models", "Landscape", "lscape_MR4_pb_rob.rds"))
saveRDS(lscape_MR_pb5_rob, here("Results", "Models", "Landscape", "lscape_MR5_pb_rob.rds"))
```

```{r}
# clear memory
rm(list = ls())
```

## Imputed case analysis

### Functions

These custom functions enable the imputed case analyses to be run in parallel with each iteration running on a CPU core simultaneously. Each different model has its own function including the publication bias models.

```{r}
MMA <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ 1, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR1 <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Method + Plot_size, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR2 <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ -1 + Method + Plot_size, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR3 <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Animal + Plot_size, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR4 <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ -1 + Animal + Plot_size, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR5 <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Method * Months + Plot_size, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MMA_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ 1 + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR1_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Method + Plot_size + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR2_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ -1 + Method + Plot_size + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR3_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Animal + Plot_size + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR4_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ -1 + Animal + Plot_size + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

MR5_pb <- function(data, VCV_mat, i) {
  rma.mv(Effect_size ~ Method * Months + Plot_size + Year + root_inv_ESS, 
         V = VCV_mat, 
         test = "t", 
         dfs = "contain", 
         random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), 
         data = data, 
         verbose = TRUE) }

num_cores <- 20 # 20 iterations of the data therefore 20 cores to be used - set to an appropriate number based on your own computational power
```

### Plant scale

#### Divide data

```{r}
df_imp_all <- readRDS(here("Analysis", "All_impcase_es.rds"))

df_imp_plant <- lapply(df_imp_all, function(df){ df %>% filter(Scale == "Plant") })
```

OLRE

```{r}
df_imp_plant1 <- lapply(df_imp_plant, function(df){ 
  df %>% mutate(OLRE = as.factor(row_number())) })
```

#### Variance Covariance matrices

```{r}
VCV_mat_plant_imp <- lapply(df_imp_plant1, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) })
```

#### Multilevel Meta-analytic model

```{r}
imp_plant_MMA_mod1 <- list()

for (i in seq_along(df_imp_plant1)) { 
  imp_plant_MMA_mod1[[i]] <- rma.mv(Effect_size ~ 1, V = VCV_mat_plant_imp[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant1[[i]], verbose = TRUE) }

imp_plant_MMA_pool1 <- summary(pool(imp_plant_MMA_mod1))
print(imp_plant_MMA_pool1)
#orchaRd::i2_ml(imp_plant_MMA_pool1) #this will work on any of the frames in the imp_plant_MMA_mod1 list but not on the pooled

imp_plant_MMA_rob <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MMA_rob[[i]] <- robust(imp_plant_MMA_mod1[[i]], cluster = df_imp_plant1[[i]]$Paper_ID) }
```

#### Multilevel Meta-regression models

```{r}
imp_plant_MR_mod1 <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod1[[i]] <- rma.mv(Effect_size ~ Method + Plot_size, V = VCV_mat_plant_imp[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_mod1))

imp_plant_MR_mod2 <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod2[[i]] <- rma.mv(Effect_size ~ -1 + Method + Plot_size, V = VCV_mat_plant_imp[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_mod2))

imp_plant_MR_mod3 <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod3[[i]] <- rma.mv(Effect_size ~ Animal + Plot_size, V = VCV_mat_plant_imp[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_mod3))

imp_plant_MR_mod4 <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod4[[i]] <- rma.mv(Effect_size ~ -1 + Animal + Plot_size, V = VCV_mat_plant_imp[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_mod4))

df_imp_plant2 <- lapply(df_imp_plant1, function(df){ 
  df %>% filter(!(Method == "Exclusion fence")) })

VCV_mat_plant_imp1 <- lapply(df_imp_plant2, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) })

imp_plant_MR_mod5 <- list()
for (i in seq_along(df_imp_plant2)) {
  imp_plant_MR_mod5[[i]] <- rma.mv(Effect_size ~ Months + Plot_size, V = VCV_mat_plant_imp1[[i]], test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant2[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_mod5))
```

#### Non-independence sensitivity

```{r}
imp_plant_MR_mod1_rob <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod1_rob[[i]] <- robust(imp_plant_MR_mod1[[i]], cluster = df_imp_plant1[[i]]$Paper_ID) }
summary(pool(imp_plant_MR_mod1_rob))

imp_plant_MR_mod2_rob <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod2_rob[[i]] <- robust(imp_plant_MR_mod2[[i]], cluster = df_imp_plant1[[i]]$Paper_ID) }
summary(pool(imp_plant_MR_mod2_rob))

imp_plant_MR_mod3_rob <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod3_rob[[i]] <- robust(imp_plant_MR_mod3[[i]], cluster = df_imp_plant1[[i]]$Paper_ID) }
summary(pool(imp_plant_MR_mod3_rob))

imp_plant_MR_mod4_rob <- list()
for (i in seq_along(df_imp_plant1)) {
  imp_plant_MR_mod4_rob[[i]] <- robust(imp_plant_MR_mod4[[i]], cluster = df_imp_plant1[[i]]$Paper_ID) }
summary(pool(imp_plant_MR_mod4_rob))

imp_plant_MR_mod5_rob <- list()
for (i in seq_along(df_imp_plant2)) {
  imp_plant_MR_mod5_rob[[i]] <- robust(imp_plant_MR_mod5[[i]], cluster = df_imp_plant2[[i]]$Paper_ID) }
summary(pool(imp_plant_MR_mod5_rob))
```

#### Publication bias

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size
df_imp_plant_pb1 <- lapply(df_imp_plant1, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })

df_imp_plant_pb2 <- lapply(df_imp_plant2, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })
```

```{r}
imp_plant_MMA_pb <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MMA_pb[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp[[i]], mods = ~ 1 + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MMA_pb))

imp_plant_MMA_pb_rob <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MMA_pb_rob[[i]] <- robust(imp_plant_MMA_pb[[i]], cluster = df_imp_plant_pb1[[i]]$Paper_ID) }
```

```{r}
imp_plant_MR_pb1 <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb1[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp[[i]], mods = ~ Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_pb1))

imp_plant_MR_pb2 <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb2[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp[[i]], mods = ~ -1 + Method + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_pb2))

imp_plant_MR_pb3 <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb3[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp[[i]], mods = ~ Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_pb3))

imp_plant_MR_pb4 <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb4[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp[[i]], mods = ~ -1 + Animal + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb1[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_pb4))

imp_plant_MR_pb5 <- list()
for (i in seq_along(df_imp_plant_pb2)) {
  imp_plant_MR_pb5[[i]] <- rma.mv(Effect_size, V = VCV_mat_plant_imp1[[i]], mods = ~ Months + Plot_size + Year + root_inv_ESS, test = "t", dfs = "contain", random = list(~1|Paper_ID, ~1|Repeat_measures, ~1|Plant_genus, ~1|OLRE), data = df_imp_plant_pb2[[i]], verbose = TRUE) }
summary(pool(imp_plant_MR_pb5))
```

```{r}
imp_plant_MR_pb1_rob <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb1_rob[[i]] <- robust(imp_plant_MR_pb1[[i]], cluster = df_imp_plant_pb1[[i]]$Paper_ID) }

imp_plant_MR_pb2_rob <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb2_rob[[i]] <- robust(imp_plant_MR_pb2[[i]], cluster = df_imp_plant_pb1[[i]]$Paper_ID) }

imp_plant_MR_pb3_rob <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb3_rob[[i]] <- robust(imp_plant_MR_pb3[[i]], cluster = df_imp_plant_pb1[[i]]$Paper_ID) }

imp_plant_MR_pb4_rob <- list()
for (i in seq_along(df_imp_plant_pb1)) {
  imp_plant_MR_pb4_rob[[i]] <- robust(imp_plant_MR_pb4[[i]], cluster = df_imp_plant_pb1[[i]]$Paper_ID) }

imp_plant_MR_pb5_rob <- list()
for (i in seq_along(df_imp_plant_pb2)) {
  imp_plant_MR_pb5_rob[[i]] <- robust(imp_plant_MR_pb5[[i]], cluster = df_imp_plant_pb2[[i]]$Paper_ID) }
```

#### Save objects

```{r}
saveRDS(imp_plant_MMA_mod1, here("Results", "Models", "Plant", "imp_Plant_MMA.rds"))
saveRDS(imp_plant_MMA_pb, here("Results", "Models", "Plant", "imp_Plant_MMA_pb.rds"))
saveRDS(imp_plant_MMA_rob, here("Results", "Models", "Plant", "imp_Plant_MMA_rob.rds"))
saveRDS(imp_plant_MMA_pb_rob, here("Results", "Models", "Plant", "imp_Plant_MMA_pb_rob.rds"))
saveRDS(imp_plant_MR_mod1, here("Results", "Models", "Plant", "imp_Plant_MR1.rds"))
saveRDS(imp_plant_MR_mod2, here("Results", "Models", "Plant", "imp_Plant_MR2.rds"))
saveRDS(imp_plant_MR_mod3, here("Results", "Models", "Plant", "imp_Plant_MR3.rds"))
saveRDS(imp_plant_MR_mod4, here("Results", "Models", "Plant", "imp_Plant_MR4.rds"))
saveRDS(imp_plant_MR_mod5, here("Results", "Models", "Plant", "imp_Plant_MR5.rds"))
saveRDS(imp_plant_MR_mod1_rob, here("Results", "Models", "Plant", "imp_Plant_MR1_rob.rds"))
saveRDS(imp_plant_MR_mod2_rob, here("Results", "Models", "Plant", "imp_Plant_MR2_rob.rds"))
saveRDS(imp_plant_MR_mod3_rob, here("Results", "Models", "Plant", "imp_Plant_MR3_rob.rds"))
saveRDS(imp_plant_MR_mod4_rob, here("Results", "Models", "Plant", "imp_Plant_MR4_rob.rds"))
saveRDS(imp_plant_MR_mod5_rob, here("Results", "Models", "Plant", "imp_Plant_MR5_rob.rds"))
saveRDS(imp_plant_MR_pb1, here("Results", "Models", "Plant", "imp_Plant_MR_pb1.rds"))
saveRDS(imp_plant_MR_pb2, here("Results", "Models", "Plant", "imp_Plant_MR_pb2.rds"))
saveRDS(imp_plant_MR_pb3, here("Results", "Models", "Plant", "imp_Plant_MR_pb3.rds"))
saveRDS(imp_plant_MR_pb4, here("Results", "Models", "Plant", "imp_Plant_MR_pb4.rds"))
saveRDS(imp_plant_MR_pb5, here("Results", "Models", "Plant", "imp_Plant_MR_pb5.rds"))
saveRDS(imp_plant_MR_pb1_rob, here("Results", "Models", "Plant", "imp_Plant_MR_pb1_rob.rds"))
saveRDS(imp_plant_MR_pb2_rob, here("Results", "Models", "Plant", "imp_Plant_MR_pb2_rob.rds"))
saveRDS(imp_plant_MR_pb3_rob, here("Results", "Models", "Plant", "imp_Plant_MR_pb3_rob.rds"))
saveRDS(imp_plant_MR_pb4_rob, here("Results", "Models", "Plant", "imp_Plant_MR_pb4_rob.rds"))
saveRDS(imp_plant_MR_pb5_rob, here("Results", "Models", "Plant", "imp_Plant_MR_pb5_rob.rds"))
```

```{r}
rm(imp_plant_MMA_mod1, imp_plant_MMA_pb, imp_plant_MMA_mod1_rob, imp_plant_MMA_pb_rob, imp_plant_MR_mod1, imp_plant_MR_mod2, imp_plant_MR_mod3, imp_plant_MR_mod4, imp_plant_MR_mod5, imp_plant_MR_mod1_rob, imp_plant_MR_mod2_rob, imp_plant_MR_mod3_rob, imp_plant_MR_mod4_rob, imp_plant_MR_mod5_rob, imp_plant_MR_pb1, imp_plant_MR_pb2, imp_plant_MR_pb3, imp_plant_MR_pb4, imp_plant_MR_pb5, imp_plant_MR_pb1_rob, imp_plant_MR_pb2_rob, imp_plant_MR_pb3_rob, imp_plant_MR_pb4_rob, imp_plant_MR_pb5_rob, VCV_mat_plant_imp, df_imp_plant, df_imp_plant1, df_imp_plant2, df_imp_plant_pb1, df_imp_plant_pb2)
```

### Coupe scale

#### Divide data

```{r}
df_imp_all <- readRDS(here("Analysis", "All_impcase_es.rds"))
  
df_imp_coupe <- lapply(df_imp_all, function(df){ df %>% filter(Scale == "Coupe") })
```

OLRE

```{r}
df_imp_coupe1 <- lapply(df_imp_coupe, function(df){ 
  df %>% mutate(OLRE = as.factor(row_number())) })
```

#### Variance Covariance matrices

```{r}
VCV_mat_coupe_imp <- lapply(df_imp_coupe1, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) }) 
```

#### Multilevel Meta-analytic model

```{r}
imp_coupe_MMA_mod1 <- list()
imp_coupe_MMA_mod1 <- lapply(seq_along(df_imp_coupe1), 
                               function(i) MMA(df_imp_coupe1[[i]], VCV_mat_coupe_imp[[i]], i))

summary(pool(imp_coupe_MMA_mod1))
saveRDS(imp_coupe_MMA_mod1, here("Results", "Models", "Coupe", "imp_coupe_MMA.rds"))

imp_coupe_MMA_rob <- list()
for (i in seq_along(df_imp_coupe1)) {
  imp_coupe_MMA_rob[[i]] <- robust(imp_coupe_MMA_mod1[[i]], cluster = df_imp_coupe1[[i]]$Paper_ID) }

saveRDS(imp_coupe_MMA_rob, here("Results", "Models", "Coupe", "imp_coupe_MMA_rob.rds"))
rm(imp_coupe_MMA_mod1, imp_coupe_MMA_rob)
```

#### Multilevel Meta-regression models

```{r}
#subset to remove guardian animal - too few effects to model reliably
df_imp_coupe2 <- lapply(df_imp_coupe1, function(df){ 
  df %>% filter(!(Method == "Guardian animal")) })

VCV_mat_coupe_imp1 <- lapply(df_imp_coupe2, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) })
```

```{r}
imp_coupe_MR_mod1 <- list()
imp_coupe_MR_mod1 <- mclapply(seq_along(df_imp_coupe2), 
                              function(i) MR1(df_imp_coupe2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_mod1))
saveRDS(imp_coupe_MR_mod1, here("Results", "Models", "Coupe", "imp_coupe_MR1.rds"))
```

```{r}
imp_coupe_MR_mod2 <- list()
imp_coupe_MR_mod2 <- mclapply(seq_along(df_imp_coupe2), 
                              function(i) MR2(df_imp_coupe2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_mod2))
saveRDS(imp_coupe_MR_mod2, here("Results", "Models", "Coupe", "imp_coupe_MR2.rds"))
```

```{r}
imp_coupe_MR_mod3 <- list()
imp_coupe_MR_mod3 <- mclapply(seq_along(df_imp_coupe1), 
                              function(i) MR3(df_imp_coupe1[[i]], VCV_mat_coupe_imp[[i]], i), mc.cores= num_cores)
summary(pool(imp_coupe_MR_mod3))
saveRDS(imp_coupe_MR_mod3, here("Results", "Models", "Coupe", "imp_coupe_MR3.rds"))
```

```{r}
imp_coupe_MR_mod4 <- list()
imp_coupe_MR_mod4 <- mclapply(seq_along(df_imp_coupe1), 
                              function(i) MR4(df_imp_coupe1[[i]], VCV_mat_coupe_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_mod4))
saveRDS(imp_coupe_MR_mod4, here("Results", "Models", "Coupe", "imp_coupe_MR4.rds"))
```

```{r}
imp_coupe_MR_mod5 <- list()
imp_coupe_MR_mod5 <- mclapply(seq_along(df_imp_coupe2), 
                              function(i) MR5(df_imp_coupe2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_mod5))
saveRDS(imp_coupe_MR_mod5, here("Results", "Models", "Coupe", "imp_coupe_MR5.rds"))
```

#### Non-independence sensitivity

```{r}
imp_coupe_MR_mod1_rob <- list()

for (i in seq_along(df_imp_coupe2)) {
  imp_coupe_MR_mod1_rob[[i]] <- robust(imp_coupe_MR_mod1[[i]], cluster = df_imp_coupe2[[i]]$Paper_ID) }

summary(pool(imp_coupe_MR_mod1_rob))
saveRDS(imp_coupe_MR_mod1_rob, here("Results", "Models", "Coupe", "imp_coupe_MR1_rob.rds"))
rm(imp_coupe_MR_mod1_rob, imp_coupe_MR_mod1)
```

```{r}
imp_coupe_MR_mod2_rob <- list()

for (i in seq_along(df_imp_coupe2)) {
  imp_coupe_MR_mod2_rob[[i]] <- robust(imp_coupe_MR_mod2[[i]], cluster = df_imp_coupe2[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_mod2_rob, here("Results", "Models", "Coupe", "imp_coupe_MR2_rob.rds"))
rm(imp_coupe_MR_mod2_rob, imp_coupe_MR_mod2)
```

```{r}
imp_coupe_MR_mod3_rob <- list()

for (i in seq_along(df_imp_coupe1)) {
  imp_coupe_MR_mod3_rob[[i]] <- robust(imp_coupe_MR_mod3[[i]], cluster = df_imp_coupe1[[i]]$Paper_ID) }

summary(pool(imp_coupe_MR_mod3_rob))
saveRDS(imp_coupe_MR_mod3_rob, here("Results", "Models", "Coupe", "imp_coupe_MR3_rob.rds"))
rm(imp_coupe_MR_mod3_rob, imp_coupe_MR_mod3)
```

```{r}
imp_coupe_MR_mod4_rob <- list()

for (i in seq_along(df_imp_coupe1)) {
  imp_coupe_MR_mod4_rob[[i]] <- robust(imp_coupe_MR_mod4[[i]], cluster = df_imp_coupe1[[i]]$Paper_ID) }

summary(pool(imp_coupe_MR_mod4_rob))
saveRDS(imp_coupe_MR_mod4_rob, here("Results", "Models", "Coupe", "imp_coupe_MR4_rob.rds"))
rm(imp_coupe_MR_mod4_rob, imp_coupe_MR_mod4)
```

```{r}
imp_coupe_MR_mod5_rob <- list()

for (i in seq_along(df_imp_coupe2)) {
  imp_coupe_MR_mod5_rob[[i]] <- robust(imp_coupe_MR_mod5[[i]], cluster = df_imp_coupe2[[i]]$Paper_ID) }

summary(pool(imp_coupe_MR_mod5_rob))
saveRDS(imp_coupe_MR_mod5_rob, here("Results", "Models", "Coupe", "imp_coupe_MR5_rob.rds"))
rm(imp_coupe_MR_mod5_rob, imp_coupe_MR_mod5)
```

#### Publication bias

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size

df_imp_coupe_pb1 <- lapply(df_imp_coupe1, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })

df_imp_coupe_pb2 <- lapply(df_imp_coupe2, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })
```

```{r}
imp_coupe_MMA_pb <- list()
imp_coupe_MMA_pb <- lapply(seq_along(df_imp_coupe_pb1), 
                              function(i) MMA_pb(df_imp_coupe_pb1[[i]], VCV_mat_coupe_imp[[i]], i))
summary(pool(imp_coupe_MMA_pb))
saveRDS(imp_coupe_MMA_pb, here("Results", "Models", "Coupe", "imp_coupe_MMA_pb.rds"))


imp_coupe_MMA_pb_rob <- list()
for (i in seq_along(df_imp_coupe_pb1)) {
  imp_coupe_MMA_pb_rob[[i]] <- robust(imp_coupe_MMA_pb[[i]], cluster = df_imp_coupe_pb1[[i]]$Paper_ID) }

saveRDS(imp_coupe_MMA_pb_rob, here("Results", "Models", "Coupe", "imp_coupe_MMA_pb_rob.rds"))

rm(imp_coupe_MMA_pb, imp_coupe_MMA_pb_rob)
```

```{r}
imp_coupe_MR_pb1 <- list()
imp_coupe_MR_pb1 <- mclapply(seq_along(df_imp_coupe_pb2), 
                             function(i) MR1_pb(df_imp_coupe_pb2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_pb1))
saveRDS(imp_coupe_MR_pb1, here("Results", "Models", "Coupe", "imp_coupe_MR1_pb.rds"))

imp_coupe_MR_pb1_rob <- list()
for (i in seq_along(df_imp_coupe_pb2)) {
  imp_coupe_MR_pb1_rob[[i]] <- robust(imp_coupe_MR_pb1[[i]], cluster = df_imp_coupe_pb2[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_pb1_rob, here("Results", "Models", "Coupe", "imp_coupe_MR1_pb_rob.rds"))
rm(imp_coupe_MR_pb1, imp_coupe_MR_pb1_rob)
```

```{r}
imp_coupe_MR_pb2 <- list()
imp_coupe_MR_pb2 <- mclapply(seq_along(df_imp_coupe_pb2), 
                             function(i) MR2_pb(df_imp_coupe_pb2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_pb2))
saveRDS(imp_coupe_MR_pb2, here("Results", "Models", "Coupe", "imp_coupe_MR2_pb.rds"))

imp_coupe_MR_pb2_rob <- list()
for (i in seq_along(df_imp_coupe_pb2)) {
  imp_coupe_MR_pb2_rob[[i]] <- robust(imp_coupe_MR_pb2[[i]], cluster = df_imp_coupe_pb2[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_pb2_rob, here("Results", "Models", "Coupe", "imp_coupe_MR2_pb_rob.rds"))
rm(imp_coupe_MR_pb2, imp_coupe_MR_pb2_rob)
```

```{r}
imp_coupe_MR_pb3 <- list()
imp_coupe_MR_pb3 <- mclapply(seq_along(df_imp_coupe_pb1), 
                             function(i) MR3_pb(df_imp_coupe_pb1[[i]], VCV_mat_coupe_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_pb3))
saveRDS(imp_coupe_MR_pb3, here("Results", "Models", "Coupe", "imp_coupe_MR3_pb.rds"))

imp_coupe_MR_pb3_rob <- list()
for (i in seq_along(df_imp_coupe_pb1)) {
  imp_coupe_MR_pb3_rob[[i]] <- robust(imp_coupe_MR_pb3[[i]], cluster = df_imp_coupe_pb1[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_pb3_rob, here("Results", "Models", "Coupe", "imp_coupe_MR3_pb_rob.rds"))
rm(imp_coupe_MR_pb3, imp_coupe_MR_pb3_rob)
```

```{r}
imp_coupe_MR_pb4 <- list()
imp_coupe_MR_pb4 <- mclapply(seq_along(df_imp_coupe_pb1), 
                             function(i) MR4_pb(df_imp_coupe_pb1[[i]], VCV_mat_coupe_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_pb4))
saveRDS(imp_coupe_MR_pb4, here("Results", "Models", "Coupe", "imp_coupe_MR4_pb.rds"))

imp_coupe_MR_pb4_rob <- list()
for (i in seq_along(df_imp_coupe_pb1)) {
  imp_coupe_MR_pb4_rob[[i]] <- robust(imp_coupe_MR_pb4[[i]], cluster = df_imp_coupe_pb1[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_pb4_rob, here("Results", "Models", "Coupe", "imp_coupe_MR4_pb_rob.rds"))
rm(imp_coupe_MR_pb4, imp_coupe_MR_pb4_rob)
```

```{r}
imp_coupe_MR_pb5 <- list()
imp_coupe_MR_pb5 <- mclapply(seq_along(df_imp_coupe_pb2), 
                             function(i) MR5_pb(df_imp_coupe_pb2[[i]], VCV_mat_coupe_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_coupe_MR_pb5))
saveRDS(imp_coupe_MR_pb5, here("Results", "Models", "Coupe", "imp_coupe_MR5_pb.rds"))

imp_coupe_MR_pb5_rob <- list()
for (i in seq_along(df_imp_coupe_pb2)) {
  imp_coupe_MR_pb5_rob[[i]] <- robust(imp_coupe_MR_pb5[[i]], cluster = df_imp_coupe_pb2[[i]]$Paper_ID) }

saveRDS(imp_coupe_MR_pb5_rob, here("Results", "Models", "Coupe", "imp_coupe_MR5_pb_rob.rds"))
rm(imp_coupe_MR_pb5, imp_coupe_MR_pb5_rob)
```

```{r}
rm(df_imp_coupe, df_imp_coupe1, df_imp_coupe2, df_imp_coupe_pb1, df_imp_coupe_pb2, VCV_mat_coupe_imp, VCV_mat_coupe_imp1)
```

### Landscape scale

#### Divide data

```{r}
df_imp_all <- readRDS(here("Analysis", "All_impcase_es.rds"))

df_imp_lscape <- lapply(df_imp_all, function(df){ df %>% filter(Scale == "Landscape") })
```

OLRE

```{r}
df_imp_lscape1 <- lapply(df_imp_lscape, function(df){ 
  df %>% mutate(OLRE = as.factor(row_number())) })
```

#### Variance Covariance matrices

```{r}
VCV_mat_lscape_imp <- lapply(df_imp_lscape1, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) })
```

#### Multilevel Meta-analytic model

```{r}
imp_lscape_MMA_mod1 <- list()

imp_lscape_MMA_mod1 <- mclapply(seq_along(df_imp_lscape1), 
                                function(i) MMA(df_imp_lscape1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)

saveRDS(imp_lscape_MMA_mod1, here("Results", "Models", "Landscape", "imp_lscape_MMA.rds"))

imp_lscape_MMA_rob <- list()
for (i in seq_along(df_imp_lscape1)) {
  imp_lscape_MMA_rob[[i]] <- robust(imp_lscape_MMA_mod1[[i]], cluster = df_imp_lscape1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MMA_rob, here("Results", "Models", "Landscape", "imp_lscape_MMA_rob.rds"))
rm(imp_lscape_MMA_mod1, imp_lscape_MMA_rob)
```

#### Multilevel Meta-regression models

```{r}
imp_lscape_MR_mod1 <- list()
imp_lscape_MR_mod1 <- lapply(seq_along(df_imp_lscape1), 
                               function(i) MR1(df_imp_lscape1[[i]], VCV_mat_lscape_imp[[i]], i))
summary(pool(imp_lscape_MR_mod1))
saveRDS(imp_lscape_MR_mod1, here("Results", "Models", "Landscape", "imp_lscape_MR1.rds"))
```

```{r}
imp_lscape_MR_mod2 <- list()
imp_lscape_MR_mod2 <- mclapply(seq_along(df_imp_lscape1), 
                               function(i) MR2(df_imp_lscape1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_mod2))
saveRDS(imp_lscape_MR_mod2, here("Results", "Models", "Landscape", "imp_lscape_MR2.rds"))
```

```{r}
imp_lscape_MR_mod3 <- list()
imp_lscape_MR_mod3 <- mclapply(seq_along(df_imp_lscape1), 
                               function(i) MR3(df_imp_lscape1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_mod3))
saveRDS(imp_lscape_MR_mod3, here("Results", "Models", "Landscape", "imp_lscape_MR3.rds"))
```

```{r}
imp_lscape_MR_mod4 <- list()
imp_lscape_MR_mod4 <- mclapply(seq_along(df_imp_lscape1), 
                               function(i) MR4(df_imp_lscape1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_mod4))
saveRDS(imp_lscape_MR_mod4, here("Results", "Models", "Landscape", "imp_lscape_MR4.rds"))
```

```{r}
# subset out methods with fewer than k=15
df_imp_lscape2 <- lapply(df_imp_lscape1, function(df){
  df %>% filter(!(Method == "Other fencing" | Method == "Stock manipulation")) })

VCV_mat_lscape_imp1 <- lapply(df_imp_lscape2, function(df){
  vcalc(vi = Sampling_variance, cluster = Shared_data, data = df, rho = 0.5, nearpd = TRUE) })
```

```{r}
imp_lscape_MR_mod5 <- list()
imp_lscape_MR_mod5 <- mclapply(seq_along(df_imp_lscape2), 
                               function(i) MR5(df_imp_lscape2[[i]], VCV_mat_lscape_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_mod5))
saveRDS(imp_lscape_MR_mod5, here("Results", "Models", "Landscape", "imp_lscape_MR5.rds"))
```

#### Non-independence sensitivity

```{r}
imp_lscape_MR_mod1_rob <- list()

for (i in seq_along(df_imp_lscape1)) {
  imp_lscape_MR_mod1_rob[[i]] <- robust(imp_lscape_MR_mod1[[i]], cluster = df_imp_lscape1[[i]]$Paper_ID) }

summary(pool(imp_lscape_MR_mod1_rob))
saveRDS(imp_lscape_MR_mod1_rob, here("Results", "Models", "Landscape", "imp_lscape_MR1_rob.rds"))
rm(imp_lscape_MR_mod1_rob, imp_lscape_MR_mod1)
```

```{r}
imp_lscape_MR_mod2_rob <- list()

for (i in seq_along(df_imp_lscape1)) {
  imp_lscape_MR_mod2_rob[[i]] <- robust(imp_lscape_MR_mod2[[i]], cluster = df_imp_lscape1[[i]]$Paper_ID) }

summary(pool(imp_lscape_MR_mod2_rob))
saveRDS(imp_lscape_MR_mod2_rob, here("Results", "Models", "Landscape", "imp_lscape_MR2_rob.rds"))
rm(imp_lscape_MR_mod2_rob, imp_lscape_MR_mod2)
```

```{r}
imp_lscape_MR_mod3_rob <- list()

for (i in seq_along(df_imp_lscape1)) {
  imp_lscape_MR_mod3_rob[[i]] <- robust(imp_lscape_MR_mod3[[i]], cluster = df_imp_lscape1[[i]]$Paper_ID) }

summary(pool(imp_lscape_MR_mod3_rob))
saveRDS(imp_lscape_MR_mod3_rob, here("Results", "Models", "Landscape", "imp_lscape_MR3_rob.rds"))
rm(imp_lscape_MR_mod3_rob, imp_lscape_MR_mod3)
```

```{r}
imp_lscape_MR_mod4_rob <- list()

for (i in seq_along(df_imp_lscape1)) {
  imp_lscape_MR_mod4_rob[[i]] <- robust(imp_lscape_MR_mod4[[i]], cluster = df_imp_lscape1[[i]]$Paper_ID) }

summary(pool(imp_lscape_MR_mod4_rob))
saveRDS(imp_lscape_MR_mod4_rob, here("Results", "Models", "Landscape", "imp_lscape_MR4_rob.rds"))
rm(imp_lscape_MR_mod4_rob, imp_lscape_MR_mod4)
```

```{r}
imp_lscape_MR_mod5_rob <- list()

for (i in seq_along(df_imp_lscape2)) {
  imp_lscape_MR_mod5_rob[[i]] <- robust(imp_lscape_MR_mod5[[i]], cluster = df_imp_lscape2[[i]]$Paper_ID) }

summary(pool(imp_lscape_MR_mod5_rob))
saveRDS(imp_lscape_MR_mod5_rob, here("Results", "Models", "Landscape", "imp_lscape_MR5_rob.rds"))
rm(imp_lscape_MR_mod5_rob, imp_lscape_MR_mod5)
```

#### Publication bias

##### Meta-regression

```{r}
#centre the publication year
#calculate sqrt inverse effective sample size

df_imp_lscape_pb1 <- lapply(df_imp_lscape1, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })

df_imp_lscape_pb2 <- lapply(df_imp_lscape2, function(df){ 
  df %>% mutate(Year = Year - mean(Year), 
                root_inv_ESS = sqrt((Con_N + Trt_N)/(Con_N*Trt_N)) ) })
```

```{r}
imp_lscape_MMA_pb <- list()
imp_lscape_MMA_pb <- lapply(seq_along(df_imp_lscape_pb1), 
                               function(i) MMA_pb(df_imp_lscape_pb1[[i]], VCV_mat_lscape_imp[[i]], i))
summary(pool(imp_lscape_MMA_pb))
saveRDS(imp_lscape_MMA_pb, here("Results", "Models", "Landscape", "imp_lscape_MMA_pb.rds"))

imp_lscape_MMA_pb_rob <- list()

for (i in seq_along(df_imp_lscape_pb1)) {
  imp_lscape_MMA_pb_rob[[i]] <- robust(imp_lscape_MMA_pb[[i]], cluster = df_imp_lscape_pb1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MMA_pb_rob, here("Results", "Models", "Landscape", "imp_lscape_MMA_pb_rob.rds"))
rm(imp_lscape_MMA_pb, imp_lscape_MMA_pb_rob)
```

```{r}
imp_lscape_MR_pb1 <- list()
imp_lscape_MR_pb1 <- mclapply(seq_along(df_imp_lscape_pb1), 
                                function(i) MR1_pb(df_imp_lscape_pb1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_pb1))
saveRDS(imp_lscape_MR_pb1, here("Results", "Models", "Landscape", "imp_lscape_MR1_pb.rds"))

imp_lscape_MR_pb1_rob <- list()

for (i in seq_along(df_imp_lscape_pb1)) {
  imp_lscape_MR_pb1_rob[[i]] <- robust(imp_lscape_MR_pb1[[i]], cluster = df_imp_lscape_pb1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MR_pb1_rob, here("Results", "Models", "Landscape", "imp_lscape_MR1_pb_rob.rds"))
rm(imp_lscape_MR_pb1, imp_lscape_MR_pb1_rob)
```

```{r}
imp_lscape_MR_pb2 <- list()
imp_lscape_MR_pb2 <- mclapply(seq_along(df_imp_lscape_pb1), 
                                function(i) MR2_pb(df_imp_lscape_pb1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_pb2))
saveRDS(imp_lscape_MR_pb2, here("Results", "Models", "Landscape", "imp_lscape_MR2_pb.rds"))

imp_lscape_MR_pb2_rob <- list()

for (i in seq_along(df_imp_lscape_pb1)) {
  imp_lscape_MR_pb2_rob[[i]] <- robust(imp_lscape_MR_pb2[[i]], cluster = df_imp_lscape_pb1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MR_pb2_rob, here("Results", "Models", "Landscape", "imp_lscape_MR2_pb_rob.rds"))
rm(imp_lscape_MR_pb2, imp_lscape_MR_pb2_rob)
```

```{r}
imp_lscape_MR_pb3 <- list()
imp_lscape_MR_pb3 <- mclapply(seq_along(df_imp_lscape_pb1), 
                              function(i) MR3_pb(df_imp_lscape_pb1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_pb3))
saveRDS(imp_lscape_MR_pb3, here("Results", "Models", "Landscape", "imp_lscape_MR3_pb.rds"))

imp_lscape_MR_pb3_rob <- list()

for (i in seq_along(df_imp_lscape_pb1)) {
  imp_lscape_MR_pb3_rob[[i]] <- robust(imp_lscape_MR_pb3[[i]], cluster = df_imp_lscape_pb1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MR_pb3_rob, here("Results", "Models", "Landscape", "imp_lscape_MR3_pb_rob.rds"))
rm(imp_lscape_MR_pb3, imp_lscape_MR_pb3_rob)
```

```{r}
imp_lscape_MR_pb4 <- list()
imp_lscape_MR_pb4 <- mclapply(seq_along(df_imp_lscape_pb1), 
                              function(i) MR4_pb(df_imp_lscape_pb1[[i]], VCV_mat_lscape_imp[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_pb4))
saveRDS(imp_lscape_MR_pb4, here("Results", "Models", "Landscape", "imp_lscape_MR4_pb.rds"))

imp_lscape_MR_pb4_rob <- list()

for (i in seq_along(df_imp_lscape_pb1)) {
  imp_lscape_MR_pb4_rob[[i]] <- robust(imp_lscape_MR_pb4[[i]], cluster = df_imp_lscape_pb1[[i]]$Paper_ID) }

saveRDS(imp_lscape_MR_pb4_rob, here("Results", "Models", "Landscape", "imp_lscape_MR4_pb_rob.rds"))
rm(imp_lscape_MR_pb4, imp_lscape_MR_pb4_rob)
```

```{r}
imp_lscape_MR_pb5 <- list()
imp_lscape_MR_pb5 <- mclapply(seq_along(df_imp_lscape_pb2), 
                              function(i) MR5_pb(df_imp_lscape_pb2[[i]], VCV_mat_lscape_imp1[[i]], i), mc.cores = num_cores)
summary(pool(imp_lscape_MR_pb5))
saveRDS(imp_lscape_MR_pb5, here("Results", "Models", "Landscape", "imp_lscape_MR5_pb.rds"))

imp_lscape_MR_pb5_rob <- list()

for (i in seq_along(df_imp_lscape_pb2)) {
  imp_lscape_MR_pb5_rob[[i]] <- robust(imp_lscape_MR_pb5[[i]], cluster = df_imp_lscape_pb2[[i]]$Paper_ID) }

saveRDS(imp_lscape_MR_pb5_rob, here("Results", "Models", "Landscape", "imp_lscape_MR5_pb_rob.rds"))
rm(imp_lscape_MR_pb5, imp_lscape_MR_pb5_rob)
```

```{r}
rm(list = ls())
```
