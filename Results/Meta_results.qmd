---
title: "Meta_results"
author: "Jamie"
format: html
editor: visual
---

```{r}
library(pacman)
p_load(tidyverse, readxl, writexl, sf, rnaturalearth, rnaturalearthdata, patchwork, ggtext, scales, gridExtra, orchaRd, here, flextable)
```

```{r}
# functions

# plant scale bubble plot - requires different function as there's only one control method so the table structure is slightly different

plant_month_bubble <- function(df, model, method, colour, xmin, xmax, ymin, ymax){
  
  df1 <- df %>% filter(Method == method)
  
  model_results <- mod_results(model, mod = "Months", group = "Paper_ID") 
  mod_table <- model_results$mod_table
  
  mod_table_method <- mod_table
  
  plot <- ggplot(data = df1, aes(x = Months, y = Effect_size)) + 
    geom_point(aes(size = 1/sqrt(Sampling_variance)), alpha = 0.5, shape = 21, colour = colour, fill = colour) +
    labs(x = "Time / months", y = "Effect size / SMD", size = "Precision (1/SE)", title = method) + 
    ggplot2::geom_smooth(data = mod_table_method, 
                         ggplot2::aes(x = moderator , y = lowerPR), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dotted", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = upperPR), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dotted", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = lowerCL), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dashed", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = upperCL), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dashed", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = estimate), method = "loess", 
                         formula = y ~ x, se = FALSE, colour = "black") + 
    xlim(xmin,xmax) + ylim(ymin,ymax) +
    theme_bw() + theme(title = element_text(size = 10),
                       axis.title  = element_text(size = 10), 
                       axis.text = element_text(size = 8), 
                       axis.text.y = element_text(size = 8),
                       legend.text = element_text(size = 8), 
                       legend.title = element_text(size = 10))
  
  return(plot)
}

# other scale bubble plot

month_bubble <- function(df, model, method, colour, xmin, xmax, ymin, ymax){
  
  df1 <- df %>% filter(Method == method)
  
  model_results <- mod_results(model, mod = "Months", group = "Paper_ID", by = "Method") 
  mod_table <- model_results$mod_table
  
  mod_table_method <- mod_table %>% filter(condition == method)
  
  plot <- ggplot(data = df1, aes(x = Months, y = Effect_size)) + 
    geom_point(aes(size = 1/sqrt(Sampling_variance)), alpha = 0.5, shape = 21, colour = colour, fill = colour) +
    labs(x = "Time / months", y = "Effect size / SMD", size = "Precision (1/SE)", title = method) + 
    ggplot2::geom_smooth(data = mod_table_method, 
                         ggplot2::aes(x = moderator , y = lowerPR), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dotted", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = upperPR), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dotted", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = lowerCL), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dashed", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = upperCL), method = "loess", 
                         formula = y ~ x, se = FALSE, lty = "dashed", colour = "black") + 
    ggplot2::geom_smooth(data = mod_table_method, ggplot2::aes(x = moderator, y = estimate), method = "loess", 
                         formula = y ~ x, se = FALSE, colour = "black") + 
    xlim(xmin,xmax) + ylim(ymin,ymax) +
    theme_bw() + theme(title = element_text(size = 10),
                       axis.title  = element_text(size = 10), 
                       axis.text = element_text(size = 8), 
                       axis.text.y = element_text(size = 8),
                       legend.text = element_text(size = 8), 
                       legend.title = element_text(size = 10))
  
  return(plot)
}

save_plot <- function(plot, filename, height ){
  ggsave(here("Results", "Figures", filename), plot = plot, width = 16, height = height, units = "cm" , dpi = 320)
}
```

```{r}
df <- readRDS(here("Analysis", "All_impcase_es.rds"))
df1 <- df[[1]] #select one of the imputed case frames to do the summary statistics of literature synthesis.
```

# Results

## Literature synthesis

```{r}
#code to do the average effects per paper

df_avg <- df1 %>% group_by(Paper_ID) %>% 
  summarise(count = n())

df_avg <- df_avg %>% 
  summarise(N = nrow(df_avg),
            mean = mean(df_avg$count),
            sd = sd(df_avg$count),
            min = min(df_avg$count),
            max = max(df_avg$count))
```

Data were extracted from 156 papers, resulting in 2795 pairwise effect sizes (1908 complete case effects and 887 additional imputed case effects). Papers contributed an average of 17.9 +/- 42.3 (mean +/- SD) effect sizes to the data set. Experiments were distributed globally across 23 countries, see Fig XXX (map of distribution of studies). One study conducted experiments in two countries (Barrere et al., 2021): France and Sweden, hence why N = number of papers + 1.

```{r}
#edit strings for map making packages
df_map <- df1 %>% 
  mutate(Country = case_when(Country == "USA" ~ "United States of America",
                   Country == "UK" ~"United Kingdom",
                   TRUE ~ Country))

#get unique combinations of study and country - should be No. of studies + 1 because of Barrere et al
df_map1 <- df_map %>% 
  group_by(Paper_ID, Country) %>% 
  distinct(Paper_ID, Country) %>% 
  ungroup() %>% select(Country)

df_map_inset <- df_map1 %>% 
  count(Country, name = "N") %>% 
  arrange(desc(N))
map_table <- flextable(df_map_inset) %>% align(align = "center", part = "all") %>% autofit(.)
save_as_docx(map_table, path = here("Results", "Tables", "Map_table.docx"))

#map
world <- ne_countries(scale = "small", returnclass = "sf")
world <- subset(world, continent != "Antarctica") #Antarctica is unnecessary for this map - no forests

world <- merge(world, df_map_inset, by.x = "name", by.y = "Country", all.x = TRUE)
world$N[is.na(world$N)] <- 0
world$is_zero <- ifelse(world$N == 0, "Zero", "Non-zero")

map <- ggplot() +
  geom_sf(data = world[world$is_zero == "Zero", ], fill = "lightgrey", color = "black") +
  geom_sf(data = world[world$is_zero == "Non-zero", ], aes(fill = N)) +
  scale_fill_gradientn(colors = c("lightblue","turquoise","navy"), values = scales::rescale(c(1, 10, max(world$N, na.rm = TRUE))), name = "N") +
  theme_bw() + 
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "mm"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

map_plot <- map # + plot_annotation(caption = str_wrap("Fig XX. A map showing the distribution of experimental locations globally. Grey denotes N = 0. Table shows the number of papers that conducted experiments in given countries; note that N = No. of papers + 1 as Barrere et al. (2021) conducted experiments in both France and Sweden.", width = 180), theme = theme(plot.caption = element_text(hjust = 0.5, size = 14), plot.caption.position = "plot"))

#still want to add an inset table - it will increase the clarity of the figure as some of the small numbers are not easy to discern based solely on colour or make USA single colour then the others will be spread better?
```

Next tasks - write results for breakdown of the effects into broad categories. Produce tables for N \>25? and then a full table for supp info. Table will include avg effect size with SD/SE.

```{r}
#Table for supp info 

```

Results presented here are complete case analysis of XX effects.... detailed imputed case results are in sup info.....

```{r}
# plant scale orchard plots - tweak caption position and wrap as needed

df_comp_plant <- read_xlsx(here("Data processing", "Meta_full_data.xlsx"), sheet = "Complete case effects") %>% filter(Scale == "Plant")
plant_MR_mod1 <- readRDS(here("Results", "Models", "Plant", "Plant_MR1.rds"))
plant_MR_mod3 <- readRDS(here("Results", "Models", "Plant", "Plant_MR3.rds"))

p1 <- orchard_plot(plant_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "bottom.out", angle = 0, k = F, g = F) + ylim(c(-4, 6))
p2 <- orchard_plot(plant_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "none", angle = 0, k = F, g = F) + ylim(c(-4, 6))

plot1 <- p1/p2 + plot_annotation(tag_levels = "A") # plot_annotation(caption = str_wrap("Figure X. Orchard plots show total effect sizes (k) across n studies, in brackets for non-lethal browsing control at a 'plant' scale. Bubbles represent individual effect sizes, increasing size denotes increasing precision. Points show marginalised mean effect size for control methods (A) and browsing taxa (B). Thick lines show 95% confidence intervals and thin lines show prediction intervals. Note the different X axis scales between figures A and B.", width = 100), tag_levels = "A", theme = theme(plot.caption = element_text(size = 18)))
print(plot1)

save_plot(plot1, "plant_orchard.png", 16)
```

```{r}
# plant scale bubble plot - adjust axes limits, text sizes etc as necessary

colour_options <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")

plant_MR_mod5 <- readRDS(here("Results", "Models", "Plant", "Plant_MR5.rds"))

p3 <- plant_month_bubble(df_comp_plant, plant_MR_mod5, method = "Repellents", colour = "#CC6677", xmin = 0, xmax = 1.25, ymin = -4, ymax = 6)

plot2 <- p3 # + plot_annotation(caption = str_wrap("Figure X. Orchard plot showing difference in efficacy through time of non-lethal control methods employed at a 'plant' scale. Bubble size represents effect size precision, where larger bubbles represent greater precision. Solid lines show estimates for the influence of time on efficacy. Dashed lines show 95% confidence intervals and dotted lines show prediction intervals. Note the different scales of the X axes and the different sizes of the bubbles between control methods.", width = 150), theme = theme(plot.caption = element_text(size = 18)))
print(plot2) # need to fix the caption position - look rubbish when viewed in qmd but much better when viewed in plots window and zoomed out

save_plot(plot2, "plant_bubble.png", 6)
```

```{r}
# coupe scale orchard plots - tweak caption position and wrap as needed

df_comp_coupe <- read_xlsx(here("Data processing", "Meta_full_data.xlsx"), sheet = "Complete case effects") %>% filter(Scale == "Coupe")
coupe_MR_mod1 <- readRDS(here("Results", "Models", "Coupe", "coupe_MR1.rds"))
coupe_MR_mod3 <- readRDS(here("Results", "Models", "Coupe", "coupe_MR3.rds"))

c1 <- orchard_plot(coupe_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "bottom.out", angle = 0) + ylim(c(-5,10))
c2 <- orchard_plot(coupe_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "none", angle = 0) + ylim(c(-5,10))

plot3 <- c1/c2 + plot_annotation(tag_levels = "A") # + plot_annotation(caption = str_wrap("Figure X. Orchard plots show total effect sizes (k) across n studies, in brackets for non-lethal browsing control at a 'coupe' scale. Bubbles represent individual effect sizes, increasing size denotes increasing precision. Points show marginalised mean effect size for control methods (A) and browsing taxa (B). Thick lines show 95% confidence intervals and thin lines show prediction intervals. Note the different X axis scales between figures A and B.", width = 100), tag_levels = "A", theme = theme(plot.caption = element_text(size = 18)))
print(plot3)

save_plot(plot3, "coupe_orchard.png", 20)
```

```{r}
# coupe scale bubble plot - tweak caption position and axes limits as needed

colour_options <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")

coupe_MR_mod5 <- readRDS(here("Results", "Models", "Coupe", "coupe_MR5.rds"))

c3 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Exclusion fence", "#88CCEE", 0, 140, -5, 10)
c4 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Repellents", "#332288", 0, 50, -4, 6)
c5 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Tree guards", "#009E73", 0, 65, -5, 10)
c6 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Other fencing", "#117733", 0, 30, -5, 5)
c7 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Natural debris", "#CC6677", 0, 65, -3, 5)
c8 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Stock manipulation", "#AA4499", 0, 65, -3, 3)
c9 <- month_bubble(df_comp_coupe, coupe_MR_mod5, "Neighbour effects", "#DDCC77", 0, 50, -4, 3)

plot4 <- c3/c6/c9/c4 # + plot_annotation(caption = str_wrap("Figure X. Orchard plot showing difference in efficacy through time of non-lethal control methods employed at a 'coupe' scale. Bubble size represents effect size precision, where larger bubbles represent greater precision. Solid lines show estimates for the influence of time on efficacy. Dashed lines show 95% confidence intervals and dotted lines show prediction intervals. Note the different scales of the X and Y axes and the different sizes of the bubbles between control methods. The Y axis of the exclusion fence sub-plot has been limited to enhance viewing of confidence and prediction limits", width = 100), theme = theme(plot.caption = element_text(size = 18)))
plot4.1 <- c5/c7/c8 # 7 plots don't fit into one pane well and the exclusion fence time range is way bigger
print(plot4)

save_plot(plot4, "coupe_bubble.png", 20)
save_plot(plot4.1, "coupe_bubblea.png", 15)
```

```{r}
# Landscape scale orchard plots - tweak caption position and wrap as needed

df_comp_lscape <- read_xlsx(here("Data processing", "Meta_full_data.xlsx"), sheet = "Complete case effects") %>% filter(Scale == "Landscape")
lscape_MR_mod1 <- readRDS(here("Results", "Models", "Landscape", "lscape_MR1.rds"))
lscape_MR_mod3 <- readRDS(here("Results", "Models", "Landscape", "lscape_MR3.rds"))

l1 <- orchard_plot(lscape_MR_mod1, mod = "Method", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "bottom.out", angle = 0) + ylim(c(-5,5))
l2 <- orchard_plot(lscape_MR_mod3, mod = "Animal", group = "Paper_ID", xlab = "Effect size / SMD", legend.pos = "none", angle = 0) + ylim(c(-5,5))

plot5 <- l1/l2 + plot_annotation(tag_levels = "A") # + plot_annotation(caption = str_wrap("Figure X. Orchard plots show total effect sizes (k) across n studies, in brackets for non-lethal browsing control at a 'landscape' scale. Bubbles represent individual effect sizes, increasing size denotes increasing precision. Points show marginalised mean effect size for control methods (A) and browsing taxa (B). Thick lines show 95% confidence intervals and thin lines show prediction intervals. Note the different X axis scales between figures A and B.", width = 100), tag_levels = "A", theme = theme(plot.caption = element_text(size = 18)))
print(plot5)

save_plot(plot5, "lscape_orchard.png", 20)
```

```{r}
# landscape scale bubble plot - tweak caption position and axes limits as needed

colour_options <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")

lscape_MR_mod5 <- readRDS(here("Results", "Models", "Landscape", "lscape_MR5.rds"))

l3 <- month_bubble(df_comp_lscape, lscape_MR_mod5, "Exclusion fence", "#88CCEE", 0, 250, -2, 9)
l4 <- month_bubble(df_comp_lscape, lscape_MR_mod5, "Repellents", "#332288", 0, 65, -2, 4)
l5 <- month_bubble(df_comp_lscape, lscape_MR_mod5, "Tree guards", "#44AA99", 0, 65, -2, 4)
l6 <- month_bubble(df_comp_lscape, lscape_MR_mod5, "Natural debris", "#CC6677", 0, 20, -3, 3.5)

plot6 <- l3/l4/l5/l6 # + plot_annotation(caption = str_wrap("Figure X. Orchard plot showing difference in efficacy through time of non-lethal control methods employed at a 'landscape' scale. Bubble size represents effect size precision, where larger bubbles represent greater precision. Solid lines show estimates for the influence of time on efficacy. Dashed lines show 95% confidence intervals and dotted lines show prediction intervals. Note the different scales of the X and Y axes and the different sizes of the bubbles between control methods.", width = 150), theme = theme(plot.caption = element_text(size = 18)))
print(plot6)

save_plot(plot6, "lscape_bubble.png", 20)
```
